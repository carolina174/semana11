<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VFS file editor</title>
    <style>
        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        button {
            display: inline-block;
            margin: 0 1px;
            padding: 0 4px;
            height: 28px;
            line-height: 28px;
            border: 1px solid var(--vscode-checkbox-border);
            cursor: pointer;
            text-decoration: none;
            color: var(--vscode-button-foreground);
            background-color: var(--vscode-button-background);
            outline: none;
            vertical-align: middle;
        }

        button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        button:active {
            box-shadow: none;
            background-color: var(--vscode-list-activeSelectionBackground);
            color: var(--vscode-list-activeSelectionForeground);
        }

        .viewer {
            display: block;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
            box-sizing: border-box;
        }

        .content-viewer {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        .input-control {
            margin: 5px;
            width: 150px;
            height: 28px;
            box-sizing: border-box;
            display: inline-block;
            vertical-align: middle;
            border: 1px solid var(--vscode-checkbox-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
        }

        .file-options {
            background-color: var(--vscode-editorWidget-background);
            border-top: 1px solid var(--vscode-panel-border);
            border-bottom: 3px solid var(--vscode-panel-border);
            box-shadow: 0px 2px 2px 0px var(--vscode-widget-shadow);
        }

        .file-options>.option-control>label {
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
            width: 120px;
        }

        .input-controls {
            box-sizing: border-box;
            width: 100%;
            height: calc(100% - 160px);
        }

        .input-controls .text-input {
            display: block;
            width: 100%;
            height: calc(100% - 40px);
            box-sizing: border-box;
            margin-top: 10px;
            resize: none;
            border: none;
            outline: none;
            background: transparent;
            color: var(--vscode-input-foreground);
            border-bottom: 3px solid var(--vscode-panel-border);
        }
    </style>
    <script>
        (function ($) {
            let _vscodeMessageHandlers = {};
            let _vscode = acquireVsCodeApi();
            let _state = _vscode.getState() || {};
            let _mimeMap = {
                "ez": "application/andrew-inset",
                "aw": "application/applixware",
                "atom": "application/atom+xml",
                "atomcat": "application/atomcat+xml",
                "atomsvc": "application/atomsvc+xml",
                "bdoc": "application/bdoc",
                "ccxml": "application/ccxml+xml",
                "cdmia": "application/cdmi-capability",
                "cdmic": "application/cdmi-container",
                "cdmid": "application/cdmi-domain",
                "cdmio": "application/cdmi-object",
                "cdmiq": "application/cdmi-queue",
                "cu": "application/cu-seeme",
                "mpd": "application/dash+xml",
                "davmount": "application/davmount+xml",
                "dbk": "application/docbook+xml",
                "dssc": "application/dssc+der",
                "xdssc": "application/dssc+xml",
                "ecma": "application/ecmascript",
                "es": "application/ecmascript",
                "emma": "application/emma+xml",
                "epub": "application/epub+zip",
                "exi": "application/exi",
                "pfr": "application/font-tdpfr",
                "geojson": "application/geo+json",
                "gml": "application/gml+xml",
                "gpx": "application/gpx+xml",
                "gxf": "application/gxf",
                "gz": "application/gzip",
                "hjson": "application/hjson",
                "stk": "application/hyperstudio",
                "ink": "application/inkml+xml",
                "inkml": "application/inkml+xml",
                "ipfix": "application/ipfix",
                "jar": "application/java-archive",
                "war": "application/java-archive",
                "ear": "application/java-archive",
                "ser": "application/java-serialized-object",
                "class": "application/java-vm",
                "js": "application/javascript",
                "mjs": "application/javascript",
                "json": "application/json",
                "map": "application/json",
                "json5": "application/json5",
                "jsonml": "application/jsonml+json",
                "jsonld": "application/ld+json",
                "lostxml": "application/lost+xml",
                "hqx": "application/mac-binhex40",
                "cpt": "application/mac-compactpro",
                "mads": "application/mads+xml",
                "webmanifest": "application/manifest+json",
                "mrc": "application/marc",
                "mrcx": "application/marcxml+xml",
                "ma": "application/mathematica",
                "nb": "application/mathematica",
                "mb": "application/mathematica",
                "mathml": "application/mathml+xml",
                "mbox": "application/mbox",
                "mscml": "application/mediaservercontrol+xml",
                "metalink": "application/metalink+xml",
                "meta4": "application/metalink4+xml",
                "mets": "application/mets+xml",
                "mods": "application/mods+xml",
                "m21": "application/mp21",
                "mp21": "application/mp21",
                "mp4s": "application/mp4",
                "m4p": "application/mp4",
                "doc": "application/msword",
                "dot": "application/msword",
                "mxf": "application/mxf",
                "nq": "application/n-quads",
                "nt": "application/n-triples",
                "bin": "application/octet-stream",
                "dms": "application/octet-stream",
                "lrf": "application/octet-stream",
                "mar": "application/octet-stream",
                "so": "application/octet-stream",
                "dist": "application/octet-stream",
                "distz": "application/octet-stream",
                "pkg": "application/octet-stream",
                "bpk": "application/octet-stream",
                "dump": "application/octet-stream",
                "elc": "application/octet-stream",
                "deploy": "application/octet-stream",
                "exe": "application/octet-stream",
                "dll": "application/octet-stream",
                "deb": "application/octet-stream",
                "dmg": "application/octet-stream",
                "iso": "application/octet-stream",
                "img": "application/octet-stream",
                "msi": "application/octet-stream",
                "msp": "application/octet-stream",
                "msm": "application/octet-stream",
                "buffer": "application/octet-stream",
                "oda": "application/oda",
                "opf": "application/oebps-package+xml",
                "ogx": "application/ogg",
                "omdoc": "application/omdoc+xml",
                "onetoc": "application/onenote",
                "onetoc2": "application/onenote",
                "onetmp": "application/onenote",
                "onepkg": "application/onenote",
                "oxps": "application/oxps",
                "xer": "application/patch-ops-error+xml",
                "pdf": "application/pdf",
                "pgp": "application/pgp-encrypted",
                "asc": "application/pgp-signature",
                "sig": "application/pgp-signature",
                "prf": "application/pics-rules",
                "p10": "application/pkcs10",
                "p7m": "application/pkcs7-mime",
                "p7c": "application/pkcs7-mime",
                "p7s": "application/pkcs7-signature",
                "p8": "application/pkcs8",
                "ac": "application/pkix-attr-cert",
                "cer": "application/pkix-cert",
                "crl": "application/pkix-crl",
                "pkipath": "application/pkix-pkipath",
                "pki": "application/pkixcmp",
                "pls": "application/pls+xml",
                "ai": "application/postscript",
                "eps": "application/postscript",
                "ps": "application/postscript",
                "pskcxml": "application/pskc+xml",
                "raml": "application/raml+yaml",
                "rdf": "application/rdf+xml",
                "owl": "application/rdf+xml",
                "rif": "application/reginfo+xml",
                "rnc": "application/relax-ng-compact-syntax",
                "rl": "application/resource-lists+xml",
                "rld": "application/resource-lists-diff+xml",
                "rs": "application/rls-services+xml",
                "gbr": "application/rpki-ghostbusters",
                "mft": "application/rpki-manifest",
                "roa": "application/rpki-roa",
                "rsd": "application/rsd+xml",
                "rss": "application/rss+xml",
                "rtf": "application/rtf",
                "sbml": "application/sbml+xml",
                "scq": "application/scvp-cv-request",
                "scs": "application/scvp-cv-response",
                "spq": "application/scvp-vp-request",
                "spp": "application/scvp-vp-response",
                "sdp": "application/sdp",
                "setpay": "application/set-payment-initiation",
                "setreg": "application/set-registration-initiation",
                "shf": "application/shf+xml",
                "siv": "application/sieve",
                "sieve": "application/sieve",
                "smi": "application/smil+xml",
                "smil": "application/smil+xml",
                "rq": "application/sparql-query",
                "srx": "application/sparql-results+xml",
                "gram": "application/srgs",
                "grxml": "application/srgs+xml",
                "sru": "application/sru+xml",
                "ssdl": "application/ssdl+xml",
                "ssml": "application/ssml+xml",
                "tei": "application/tei+xml",
                "teicorpus": "application/tei+xml",
                "tfi": "application/thraud+xml",
                "tsd": "application/timestamped-data",
                "vxml": "application/voicexml+xml",
                "wasm": "application/wasm",
                "wgt": "application/widget",
                "hlp": "application/winhlp",
                "wsdl": "application/wsdl+xml",
                "wspolicy": "application/wspolicy+xml",
                "xaml": "application/xaml+xml",
                "xdf": "application/xcap-diff+xml",
                "xenc": "application/xenc+xml",
                "xhtml": "application/xhtml+xml",
                "xht": "application/xhtml+xml",
                "xml": "application/xml",
                "xsl": "application/xml",
                "xsd": "application/xml",
                "rng": "application/xml",
                "dtd": "application/xml-dtd",
                "xop": "application/xop+xml",
                "xpl": "application/xproc+xml",
                "xslt": "application/xslt+xml",
                "xspf": "application/xspf+xml",
                "mxml": "application/xv+xml",
                "xhvml": "application/xv+xml",
                "xvml": "application/xv+xml",
                "xvm": "application/xv+xml",
                "yang": "application/yang",
                "yin": "application/yin+xml",
                "zip": "application/zip",
                "*3gpp": "audio/3gpp",
                "adp": "audio/adpcm",
                "au": "audio/basic",
                "snd": "audio/basic",
                "mid": "audio/midi",
                "midi": "audio/midi",
                "kar": "audio/midi",
                "rmi": "audio/midi",
                "*mp3": "audio/mp3",
                "m4a": "audio/mp4",
                "mp4a": "audio/mp4",
                "mpga": "audio/mpeg",
                "mp2": "audio/mpeg",
                "mp2a": "audio/mpeg",
                "mp3": "audio/mpeg",
                "m2a": "audio/mpeg",
                "m3a": "audio/mpeg",
                "oga": "audio/ogg",
                "ogg": "audio/ogg",
                "spx": "audio/ogg",
                "s3m": "audio/s3m",
                "sil": "audio/silk",
                "wav": "audio/wav",
                "*wav": "audio/wave",
                "weba": "audio/webm",
                "xm": "audio/xm",
                "ttc": "font/collection",
                "otf": "font/otf",
                "ttf": "font/ttf",
                "woff": "font/woff",
                "woff2": "font/woff2",
                "exr": "image/aces",
                "apng": "image/apng",
                "bmp": "image/bmp",
                "cgm": "image/cgm",
                "drle": "image/dicom-rle",
                "emf": "image/emf",
                "fits": "image/fits",
                "g3": "image/g3fax",
                "gif": "image/gif",
                "heic": "image/heic",
                "heics": "image/heic-sequence",
                "heif": "image/heif",
                "heifs": "image/heif-sequence",
                "ief": "image/ief",
                "jls": "image/jls",
                "jp2": "image/jp2",
                "jpg2": "image/jp2",
                "jpeg": "image/jpeg",
                "jpg": "image/jpeg",
                "jpe": "image/jpeg",
                "jpm": "image/jpm",
                "jpx": "image/jpx",
                "jpf": "image/jpx",
                "jxr": "image/jxr",
                "ktx": "image/ktx",
                "png": "image/png",
                "sgi": "image/sgi",
                "svg": "image/svg+xml",
                "svgz": "image/svg+xml",
                "t38": "image/t38",
                "tif": "image/tiff",
                "tiff": "image/tiff",
                "tfx": "image/tiff-fx",
                "webp": "image/webp",
                "wmf": "image/wmf",
                "disposition-notification": "message/disposition-notification",
                "u8msg": "message/global",
                "u8dsn": "message/global-delivery-status",
                "u8mdn": "message/global-disposition-notification",
                "u8hdr": "message/global-headers",
                "eml": "message/rfc822",
                "mime": "message/rfc822",
                "3mf": "model/3mf",
                "gltf": "model/gltf+json",
                "glb": "model/gltf-binary",
                "igs": "model/iges",
                "iges": "model/iges",
                "msh": "model/mesh",
                "mesh": "model/mesh",
                "silo": "model/mesh",
                "stl": "model/stl",
                "wrl": "model/vrml",
                "vrml": "model/vrml",
                "*x3db": "model/x3d+binary",
                "x3dbz": "model/x3d+binary",
                "x3db": "model/x3d+fastinfoset",
                "*x3dv": "model/x3d+vrml",
                "x3dvz": "model/x3d+vrml",
                "x3d": "model/x3d+xml",
                "x3dz": "model/x3d+xml",
                "x3dv": "model/x3d-vrml",
                "appcache": "text/cache-manifest",
                "manifest": "text/cache-manifest",
                "ics": "text/calendar",
                "ifb": "text/calendar",
                "coffee": "text/coffeescript",
                "litcoffee": "text/coffeescript",
                "css": "text/css",
                "csv": "text/csv",
                "html": "text/html",
                "htm": "text/html",
                "shtml": "text/html",
                "jade": "text/jade",
                "jsx": "text/jsx",
                "less": "text/less",
                "markdown": "text/markdown",
                "md": "text/markdown",
                "mml": "text/mathml",
                "mdx": "text/mdx",
                "n3": "text/n3",
                "txt": "text/plain",
                "text": "text/plain",
                "conf": "text/plain",
                "def": "text/plain",
                "list": "text/plain",
                "log": "text/plain",
                "in": "text/plain",
                "ini": "text/plain",
                "rtx": "text/richtext",
                "*rtf": "text/rtf",
                "sgml": "text/sgml",
                "sgm": "text/sgml",
                "shex": "text/shex",
                "slim": "text/slim",
                "slm": "text/slim",
                "stylus": "text/stylus",
                "styl": "text/stylus",
                "tsv": "text/tab-separated-values",
                "t": "text/troff",
                "tr": "text/troff",
                "roff": "text/troff",
                "man": "text/troff",
                "me": "text/troff",
                "ms": "text/troff",
                "ttl": "text/turtle",
                "uri": "text/uri-list",
                "uris": "text/uri-list",
                "urls": "text/uri-list",
                "vcard": "text/vcard",
                "vtt": "text/vtt",
                "*xml": "text/xml",
                "yaml": "text/yaml",
                "yml": "text/yaml",
                "3gp": "video/3gpp",
                "3gpp": "video/3gpp",
                "3g2": "video/3gpp2",
                "h261": "video/h261",
                "h263": "video/h263",
                "h264": "video/h264",
                "jpgv": "video/jpeg",
                "*jpm": "video/jpm",
                "jpgm": "video/jpm",
                "mj2": "video/mj2",
                "mjp2": "video/mj2",
                "ts": "video/mp2t",
                "mp4": "video/mp4",
                "mp4v": "video/mp4",
                "mpg4": "video/mp4",
                "mpeg": "video/mpeg",
                "mpg": "video/mpeg",
                "mpe": "video/mpeg",
                "m1v": "video/mpeg",
                "m2v": "video/mpeg",
                "ogv": "video/ogg",
                "qt": "video/quicktime",
                "mov": "video/quicktime",
                "webm": "video/webm"
            }
            $.registerMessageHandler = function (name, handler) {
                _vscodeMessageHandlers[name] = handler;
            };
            $.callHostHandler = function (name, ...args) {
                _vscode.postMessage({
                    handler: name,
                    args: args
                });
            };
            $.addEventListener('message', event => {
                const message = event.data;
                if (message.handler && _vscodeMessageHandlers[message.handler]) {
                    let handler = _vscodeMessageHandlers[message.handler];
                    handler.apply($, message.args);
                }
            });
            $.setState = function (state) {
                _vscode.setState(state);
                _state = state;
            }
            $.getState = function () {
                return _state;
            }
            $.getMimeType = function (name) {
                name = name.substring(name.lastIndexOf('.') + 1)
                if (name.includes('/') || name.includes('\\')) {
                    return undefined;
                }
                return _mimeMap[name.toLowerCase()];
            }
        })(window);
    </script>
</head>

<body class="viewer">
    <div class="content-viewer">
        <div class="file-options">
            <div class="option-control">
                <label for="file-path">Path:</label>
                <input class="state-saveable input-control" id="file-path" type="text" disabled="disabled" />
            </div>
            <div class="option-control">
                <label for="file-type">File type:</label>
                <select class="state-saveable input-control" id="file-type">
                    <option value="content">Enter content</option>
                    <option value="script">Script handler</option>
                    <option value="file">Link file</option>
                </select>
            </div>
            <div class="option-control">
                <label for="mime-type">MIME type:</label>
                <input class="state-saveable input-control" id="mime-type" type="text" value="text/plain"
                    placeholder="MIME type" />
            </div>
            <div class="option-control">
                <label for="handler-delay-min">Delay time:</label>
                <input class="state-saveable input-control" id="handler-delay-min" type="number" />
                <span>-</span>
                <input class="state-saveable input-control" id="handler-delay-max" type="number" />
            </div>
        </div>
        <div class="input-controls">
            <textarea class="state-saveable text-input" name="file-content" id='file-content'></textarea>
            <button id="save" style="margin: 3px;">Save</button>
        </div>
    </div>
    <script type="text/javascript">
        (function () {
            let filePath = document.getElementById('file-path');
            let fileType = document.getElementById('file-type');
            let mimeType = document.getElementById('mime-type');
            let handlerDelayMin = document.getElementById('handler-delay-min');
            let handlerDelayMax = document.getElementById('handler-delay-max');
            let contentBox = document.getElementById('file-content');
            let pageState = getState();

            handlerDelayMin.addEventListener('change', () => {
                if (parseInt(handlerDelayMax.value) < parseInt(handlerDelayMin.value))
                    handlerDelayMax.value = handlerDelayMin.value;
            });
            fileType.addEventListener('change', () => {
                if (fileType.value === 'file')
                    contentBox.setAttribute("readonly", "readonly");
                else
                    contentBox.removeAttribute("readonly");
            });

            contentBox.addEventListener('click', () => {
                if (fileType.value === 'file') {
                    callHostHandler('open.file.dialog', contentBox.value);
                }
            });

            contentBox.addEventListener('keydown', function (e) {
                if (e.keyCode == 9) {
                    e.preventDefault();
                    var indent = '\t';
                    var start = this.selectionStart;
                    var end = this.selectionEnd;
                    var selected = window.getSelection().toString();
                    selected = indent + selected.replace(/\n/g, '\n' + indent);
                    this.value = this.value.substring(0, start) + selected
                        + this.value.substring(end);
                    this.setSelectionRange(start + indent.length, start
                        + selected.length);
                }
            });
            document.querySelectorAll('.state-saveable').forEach((element) => {
                let name = element.getAttribute('name');
                let isCheckbox = (element.getAttribute('type') === "checkbox");
                if (!name || name.length == 0)
                    name = element.getAttribute('id');
                if (!name || name.length == 0)
                    return;
                let statevalue = pageState[name];
                if (typeof (statevalue) !== "undefined") {
                    if (isCheckbox) {
                        element.checked = pageState[name];
                    } else {
                        element.value = pageState[name];
                    }
                }

                element.addEventListener('change', () => {
                    if (isCheckbox) {
                        pageState[name] = element.checked;
                    } else {
                        pageState[name] = element.value;
                    }
                    setState(pageState);
                })
            });
            document.getElementById('save').addEventListener('click', () => {
                callHostHandler('vitrual.file.save', {
                    path: filePath.value,
                    fileType: fileType.value,
                    contentMime: mimeType.value,
                    delayTimeMin: handlerDelayMin.value,
                    delayTimeMax: handlerDelayMax.value,
                    content: contentBox.value,
                });
            });
            registerMessageHandler('vitrual.file.update', (file) => {
                filePath.value = file.path;
                fileType.value = file.fileType;
                if (file.contentMime && file.contentMime.length > 0)
                    mimeType.value = file.contentMime;
                else {
                    if (file.fileType === 'file' && file.content && file.content.length > 0)
                        mimeType.value = getMimeType(file.content);
                    else
                        mimeType.value = getMimeType(file.path);
                }
                handlerDelayMin.value = file.delayTimeMin;
                handlerDelayMax.value = file.delayTimeMax;
                contentBox.value = file.content;
                document.querySelectorAll('.state-saveable').forEach((element) => {
                    let name = element.getAttribute('name');
                    let isCheckbox = (element.getAttribute('type') === "checkbox");
                    if (!name || name.length == 0)
                        name = element.getAttribute('id');
                    if (!name || name.length == 0)
                        return;

                    if (isCheckbox) {
                        pageState[name] = element.checked;
                    } else {
                        pageState[name] = element.value;
                    }
                    setState(pageState);
                });
            });
            registerMessageHandler('open.file.dialog.result', (filepath) => {
                if (filepath) {
                    contentBox.value = filepath;
                    let mime = getMimeType(filepath);
                    if (mime)
                        mimeType.value = mime;
                    else
                        mimeType.value = getMimeType(filePath.value);
                }
            });
            callHostHandler('page.ready');
        })();
    </script>
</body>

</html>
